<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株式評価ミニ（フェーズ3 完全版）</title>
  <style>
    :root{
      --bg:#f7f9fc;
      --card:#fff;
      --muted:#eef3f9;
      --text:#0f172a;
      --mutetext:#64748b;
      --brand:#2563eb;
      --ok:#0ea5e9;

      /* 評価色（スクリーナーと統一） */
      --green-strong:#0f766e; /* すばらしい */
      --green-soft:#34d399;   /* よい */
      --yellow:#fbbf24;       /* 様子見 */
      --red:#ef4444;          /* 売るべき */
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic UI","Yu Gothic","Meiryo",sans-serif}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 20px}
    .row{display:grid;gap:14px}
    @media(min-width:960px){.row{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:0 8px 24px rgba(2,6,23,.06)}
    .label{font-size:12px;color:var(--mutetext);margin-bottom:6px}
    .muted{background:var(--muted);border-radius:12px;padding:10px 12px}
    input[type="text"],input[type="number"]{
      width:100%;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;
      outline: none;
    }
    input[type="file"]{width:100%}
    .btn{
      background:var(--brand);color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer
    }
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .box{background:var(--muted);border-radius:14px;padding:12px}
    .box b{font-size:18px;display:block;margin-top:6px}
    .big{font-size:22px;font-weight:800}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pill{display:inline-block;border-radius:999px;padding:6px 10px;font-weight:700}
    .tag{display:inline-block;border-radius:8px;padding:3px 8px;font-size:12px;background:#f1f5f9;margin-right:8px;color:#334155}
    .list .row{grid-template-columns:1fr 120px 90px}
    .list .row div{padding:10px 8px;border-bottom:1px solid #eef2f7}
    .hdr{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .hdr .tag{background:#e5edff}
    .search{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .search input{flex:1}
    .hr{height:1px;background:#e5e7eb;margin:12px 0}
    .log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1220;color:#e2e8f0;border-radius:12px;padding:12px}
    .log .line{margin:3px 0}

    /* 評価バッジ（投資スコア合計） */
    .verdict{
      display:inline-flex;align-items:center;gap:10px;margin-top:10px
    }
    .scoreTotal{font-size:26px;font-weight:800}
    .verdictText{
      font-weight:800;padding:6px 10px;border-radius:10px;color:#fff
    }
    .v-great{background:var(--green-strong)}
    .v-good{background:var(--green-soft);color:#064e3b}
    .v-watch{background:var(--yellow);color:#4a2f00}
    .v-sell{background:var(--red)}

    /* 割安度バッジ */
    .valueBadge{
      display:inline-flex;align-items:center;font-weight:800;margin-top:8px;
      padding:4px 10px;border-radius:999px;color:#fff
    }
    .vb-cheap{background:var(--green-strong)}
    .vb-watch{background:var(--yellow);color:#4a2f00}
    .vb-sell{background:var(--red)}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>株式評価ミニ（最小構成 → フェーズ3・完全版）</h1>

    <!-- 上段：入力 + Excel -->
    <div class="card">
      <div class="grid2">
        <div>
          <div class="label">会社名</div>
          <input id="nameInput" type="text" placeholder="例 トヨタ自動車" />
        </div>
        <div>
          <div class="label">ティッカー（例 7203.T）</div>
          <input id="tickerInput" type="text" placeholder="7203.T" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">現在株価（円）</div>
          <div style="display:flex;gap:8px">
            <input id="priceInput" type="number" inputmode="numeric" placeholder="株価" />
            <button class="btn" id="btnFetch">価格を更新</button>
          </div>
        </div>
        <div>
          <div class="label">普通株式数（億株） ※ information! の 'share' を自動読み込み</div>
          <input id="shareInput" type="number" step="0.1" placeholder="例 157.9" />
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <div class="label">Excel 読込（任意）</div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="fileInput" type="file" accept=".xlsx" />
            <div class="muted" style="font-size:12px">株価分析ツール.xlsx / シート: <b>information</b></div>
          </div>
        </div>
        <div>
          <div class="label">普通株式数 自動更新</div>
          <div class="muted">Excel 取り込み時に D列 <b>share</b>（単位:億株）を自動セットします。</div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <!-- 左：魅力度（投資スコア） -->
      <div class="card">
        <div class="label">投資スコア（魅力度の合計）</div>
        <div class="kpi">
          <div class="box">
            <div class="label">営業トレンド</div>
            <b id="opTrend">-</b>
          </div>
          <div class="box">
            <div class="label">資金創出（FCF>0年数）</div>
            <b id="fundGen">-</b>
          </div>
          <div class="box">
            <div class="label">参入障壁</div>
            <b id="barrier">-</b>
          </div>
        </div>

        <div class="hr"></div>

        <div class="verdict">
          <div class="scoreTotal" id="scoreTotal">合計：-</div>
          <div id="verdict" class="verdictText v-watch">様子見企業</div>
        </div>
      </div>

      <!-- 右：割安度（目標株価と比較） -->
      <div class="card">
        <div class="label">割安度（目標株価と比較）</div>
        <div class="kpi">
          <div class="box">
            <div class="label">期待収益率 r</div>
            <b id="rLabel">-</b>
          </div>
          <div class="box">
            <div class="label">成長率 gN（標準化）</div>
            <b id="gLabel">-</b>
          </div>
          <div class="box">
            <div class="label">目標株価</div>
            <b id="target">-</b>
          </div>
        </div>

        <div id="valueJudge" class="valueBadge vb-watch" style="display:none">様子見</div>
      </div>
    </div>

    <!-- ログ -->
    <div class="card" style="margin-top:14px">
      <div class="label">ログ（新しい順）</div>
      <div class="log" id="log"></div>
    </div>

    <!-- スクリーナー（常に全件表示） -->
    <div class="card" style="margin-top:14px">
      <div class="hdr">
        <span class="tag">すばらしい：</span><span class="tag">よい：</span><span class="tag">様子見：</span><span class="tag">売るべき：</span>
      </div>
      <div class="search">
        <input id="searchInput" type="text" placeholder="社名・ティッカーで検索（一覧は常に全件表示、投資スコア降順）" />
      </div>
      <div class="list">
        <div class="row" style="font-weight:700;opacity:.7">
          <div>会社名</div><div>ティッカー</div><div>投資スコア</div>
        </div>
        <div id="listBody"></div>
      </div>
    </div>
  </div>

  <!-- ライブラリ -->
  <script src="vendor/react.production.min.js"></script>
  <script src="vendor/react-dom.production.min.js"></script>
  <script src="vendor/xlsx.full.min.js"></script>

  <script>
  // ============ ユーティリティ ============

  function fmtNum(x){
    if(x==null || !isFinite(x)) return "-";
    return Number(x).toLocaleString("ja-JP");
  }
  function fmtPct(x){
    if(!isFinite(x)) return "-";
    return (x*100).toFixed(2)+"%";
  }
  function prettyPct(x){return (x*100).toFixed(2);}

  function pushLogLine(s){
    const el=document.getElementById("log");
    if(!el) return;
    const line=document.createElement("div");
    line.className="line";
    line.textContent=s;
    el.prepend(line);
  }

  // ============ 価格取得（堅牢版：CORS回避＋フォールバック＋キャッシュ＋自動起動） ============

  const PRICE_CACHE=new Map(); // key-> {ts, price}
  const PRICE_TTL=5*60*1000;
  const wait = ms=>new Promise(r=>setTimeout(r,ms));
  const jitter=(a,b)=>Math.floor(a+Math.random()*(b-a));

  // Stooq（CSV）をJinaのHTTPリレープロキシ経由でCORS回避
  async function fetchFromStooq(tk){
    const sym=tk.replace(/\.T$/i,".jp");
    const url=`https://r.jina.ai/http://stooq.com/q/l/?s=${encodeURIComponent(sym)}&i=d`;
    const res=await fetch(url);
    if(!res.ok) throw new Error("stooq bad status");
    const csv=await res.text();
    // 2行目が最新。symbol,date,time,open,high,low,close,volume
    const line=(csv.split(/\r?\n/).filter(Boolean)[1]||"");
    const col=line.split(",");
    const px=Number(col[6]);
    if(!isFinite(px)||px<=0) throw new Error("stooq parse");
    return {price:px,source:"stooq"};
  }

  // Yahoo Quote を cors.isomorphic-git プロキシ経由
  async function fetchFromYahoo(tk){
    const target=`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(tk)}`;
    const url=`https://cors.isomorphic-git.org/${target}`;
    const res=await fetch(url);
    if(!res.ok) throw new Error("yahoo bad status");
    const js=await res.json();
    const q=js?.quoteResponse?.result?.[0];
    const px=Number(q?.regularMarketPrice ?? q?.postMarketPrice ?? q?.preMarketPrice);
    if(!isFinite(px)||px<=0) throw new Error("yahoo parse");
    return {price:px,source:"yahoo"};
  }

  async function robustFetchPrice(tk){
    const key=tk.toUpperCase().trim();
    const hit=PRICE_CACHE.get(key);
    const now=Date.now();
    if(hit && (now-hit.ts)<PRICE_TTL){
      return {price:hit.price,source:"cache"};
    }
    const fetchers=[fetchFromYahoo,fetchFromStooq];
    let err;
    for(const f of fetchers){
      for(let i=0;i<3;i++){
        try{
          const r=await f(key);
          PRICE_CACHE.set(key,{ts:Date.now(),price:r.price});
          return r;
        }catch(e){
          err=e;
          await wait(180 + jitter(80,220)*(i+1));
        }
      }
    }
    throw err ?? new Error("all fetchers failed");
  }

  async function updatePriceUI(tk){
    const el=document.getElementById("priceInput");
    if(!el) return;
    try{
      const r=await robustFetchPrice(tk);
      el.value=String(Math.round(r.price));
      pushLogLine(`OK ${Math.round(r.price)} (${r.source})`);
    }catch(e){
      pushLogLine("価格の自動取得に失敗しました");
      console.error(e);
    }
  }
  async function fetchPrice(ticker){
    const tk=(ticker || document.getElementById("tickerInput")?.value || "").trim();
    if(!tk){pushLogLine("ティッカーが空です");return;}
    await updatePriceUI(tk);
  }
  document.addEventListener("DOMContentLoaded",()=>{
    setTimeout(()=>{
      const tk=(document.getElementById("tickerInput")?.value||"").trim();
      if(tk) fetchPrice(tk);
    },600);
  });
  document.getElementById("btnFetch").addEventListener("click", ()=>{
    const tk=(document.getElementById("tickerInput")?.value||"").trim();
    if(tk) fetchPrice(tk);
  });
  const tickerEl=document.getElementById("tickerInput");
  if(tickerEl){
    tickerEl.addEventListener("change",()=>{
      const tk=(tickerEl.value||"").trim();
      if(tk) fetchPrice(tk);
    });
  }

  // ============ Excel 読み込み & スクリーナー ============

  let rows=[];     // {name,ticker, share(億株), op2021..op2025, op2026, op2027, fcf2021.., roe2021..}
  let filtered=[]; // スクリーナー表示用

  function parseSheetToRows(wb){
    const ws=wb.Sheets["information"] || wb.Sheets[wb.SheetNames[0]];
    if(!ws){alert("information シートが見つかりません");return [];}
    const json=XLSX.utils.sheet_to_json(ws,{defval:null, header:1});
    if(!json.length) return [];
    const head=json[0].map(h=>String(h||"").trim());
    // 列位置
    const col = (name) => head.findIndex(h=>String(h).trim().toLowerCase()===String(name).trim().toLowerCase());

    const idxName = col("name")>=0 ? col("name") : 0;
    const idxTicker = col("ticker")>=0 ? col("ticker") : 1;
    const idxShare = col("share")>=0 ? col("share") : 3; // D列想定（億株）
    // OP：2021..2025 想定（列名 2021,2022,2023,2024,2025）
    const iOp21 = col("2021");
    const iOp22 = col("2022");
    const iOp23 = col("2023");
    const iOp24 = col("2024");
    const iOp25 = col("2025");
    // 予想 OP：J=Op_2026, K=Op_2027
    const iOp26 = col("op_2026");
    const iOp27 = col("op_2027");
    // FCF
    const iFcf21 = col("fcf_2021");
    const iFcf22 = col("fcf_2022");
    const iFcf23 = col("fcf_2023");
    const iFcf24 = col("fcf_2024");
    const iFcf25 = col("fcf_2025");
    // ROE
    const iRoe21 = col("roe_2021");
    const iRoe22 = col("roe_2022");
    const iRoe23 = col("roe_2023");
    const iRoe24 = col("roe_2024");
    const iRoe25 = col("roe_2025");

    const out=[];
    for(let r=1;r<json.length;r++){
      const row=json[r];
      if(!row || (!row[idxName] && !row[idxTicker])) continue;
      out.push({
        name: row[idxName] ?? "",
        ticker: row[idxTicker] ?? "",
        share: Number(row[idxShare]) || null, // 億株
        op: {
          "2021": Number(row[iOp21]) || null,
          "2022": Number(row[iOp22]) || null,
          "2023": Number(row[iOp23]) || null,
          "2024": Number(row[iOp24]) || null,
          "2025": Number(row[iOp25]) || null,
          "2026": Number(row[iOp26]) || null,
          "2027": Number(row[iOp27]) || null,
        },
        fcf: {
          "2021": Number(row[iFcf21]) || null,
          "2022": Number(row[iFcf22]) || null,
          "2023": Number(row[iFcf23]) || null,
          "2024": Number(row[iFcf24]) || null,
          "2025": Number(row[iFcf25]) || null,
        },
        roe: {
          "2021": Number(row[iRoe21]) || null,
          "2022": Number(row[iRoe22]) || null,
          "2023": Number(row[iRoe23]) || null,
          "2024": Number(row[iRoe24]) || null,
          "2025": Number(row[iRoe25]) || null,
        }
      });
    }
    return out;
  }

  function renderList(){
    const kw=(document.getElementById("searchInput")?.value||"").trim().toLowerCase();
    // スコア降順で全件表示（いつも全件）
    const list=rows.slice().map(r=>{
      const s=calcInvestScore(r);
      return {...r, score:s.total}
    }).sort((a,b)=>b.score-a.score);

    filtered=list;
    const body=document.getElementById("listBody");
    body.innerHTML="";
    list.forEach(r=>{
      const ok= !kw || r.name.toLowerCase().includes(kw) || r.ticker.toLowerCase().includes(kw);
      const row=document.createElement("div");
      row.className="row";
      row.style.opacity = ok ? 1 : .3;
      row.innerHTML=`<div>${r.name}</div><div>${r.ticker}</div><div>${r.score.toFixed(2)}</div>`;
      row.addEventListener("click",()=>fillFromRow(r,true));
      body.appendChild(row);
    });
  }
  document.getElementById("searchInput").addEventListener("input", renderList);

  document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const f=e.target.files?.[0];
    if(!f) return;
    const ab=await f.arrayBuffer();
    const wb=XLSX.read(ab,{type:"array"});
    rows=parseSheetToRows(wb);
    renderList();
    if(rows.length){
      fillFromRow(rows[0],true);
      pushLogLine(`Excel loaded: information / ${rows.length} rows`);
    }
  });

  // ============ 計算ロジック ============

  function ratio(a,b){ if(!isFinite(a)||!isFinite(b)||b===0) return 0; return a/b; }

  // 投資スコア（営業トレンド / FCF>0 年数 / 参入障壁（ROE））
  function calcInvestScore(r){
    // 営業トレンド：過去5年 OP（2021..2025）の CAGR を 0〜7 でざっくりスコア化
    const op=[r?.op?.["2021"],r?.op?.["2022"],r?.op?.["2023"],r?.op?.["2024"],r?.op?.["2025"]].filter(x=>isFinite(x));
    let trend=0;
    if(op.length>=2){
      const g=Math.pow(op[op.length-1]/op[0],1/(op.length-1))-1;
      trend = Math.max(0, Math.min(7, (g*100)/2 )); // 感度は任意（%/2）
    }
    // FCF>0 年数（0〜5）
    const fcf=[r?.fcf?.["2021"],r?.fcf?.["2022"],r?.fcf?.["2023"],r?.fcf?.["2024"],r?.fcf?.["2025"]];
    const gen=(fcf.filter(v=>isFinite(v)&&v>0)).length; // 0..5
    // 参入障壁＝直近ROE（2025）を 0〜7 で正規化
    const roe=Number(r?.roe?.["2025"]);
    let barrier=0;
    if(isFinite(roe)){
      barrier=Math.max(0,Math.min(7, roe/3 )); // 目安（3% で 1pt）
    }

    const total=trend + (gen*1.0) + barrier;
    return {trend, gen, barrier, total};
  }

  // r, gN, 目標株価
  function calcValuation(ctx){
    const price=Number(document.getElementById("priceInput")?.value)||0;
    const share=Number(document.getElementById("shareInput")?.value)||0; // 億株
    const op2025=Number(ctx?.op?.["2025"])||0;
    const op2026=Number(ctx?.op?.["2026"])||0;
    const op2027=Number(ctx?.op?.["2027"])||0;

    // === g の算出：来期があれば sqrt(op2027/op2025)-1、なければ (op2026/op2025)-1
    let g = 0;
    if(op2027>0 && op2025>0){
      g = Math.sqrt(op2027/op2025) - 1;
    }else if(op2026>0 && op2025>0){
      g = (op2026/op2025) - 1;
    }

    // r は簡易： 市場期待 6.5% をベース（任意で微調整）
    const r = 0.066;

    // 標準化 gN（上限下限でクリップ）
    const gN = Math.max(-0.05, Math.min(0.12, g));

    // 目標株価：超簡易（営業利益 × 係数 → 時価総額 / 株数）
    //   係数は (10 + 60*gN) をベース（gN=0 で 10倍、gN=0.1 付近で 16倍）
    //   単位は億円 / 億株 = 円換算のため ×100
    const mult = 10 + 60*gN;
    const mktcap = (op2026>0? op2026 : op2025) * mult; // 億円
    const target = (share>0)? (mktcap / share)*100 : 0; // 円

    return {r, gN, target, price};
  }

  function colorVerdict(v){
    const el=document.getElementById("verdict");
    el.className="verdictText";
    if(v==="すばらしい企業"){ el.classList.add("v-great"); }
    else if(v==="よい企業"){ el.classList.add("v-good"); }
    else if(v==="様子見企業"){ el.classList.add("v-watch"); }
    else { el.classList.add("v-sell"); }
    el.textContent=v;
  }

  function colorValueBadge(target, price){
    const badge=document.getElementById("valueJudge");
    if(!badge) return;
    badge.style.display="inline-flex";
    badge.className="valueBadge";
    if(target > price*2){
      badge.classList.add("vb-cheap");
      badge.textContent="割安";
    }else if(target > price){
      badge.classList.add("vb-watch");
      badge.textContent="様子見";
    }else{
      badge.classList.add("vb-sell");
      badge.textContent="売るべき";
    }
  }

  function reflectCalc(ctx){
    // 投資スコア
    const s=calcInvestScore(ctx);
    document.getElementById("opTrend").textContent = s.trend.toFixed(2);
    document.getElementById("fundGen").textContent = s.gen.toFixed(2);
    document.getElementById("barrier").textContent = s.barrier.toFixed(2);
    document.getElementById("scoreTotal").textContent = "合計：" + s.total.toFixed(2);

    // verdict
    let v="様子見企業";
    if(s.total>=12){ v="すばらしい企業"; }
    else if(s.total>=9){ v="よい企業"; }
    else if(s.total<6){ v="売るべき企業"; }
    colorVerdict(v);

    // 目標株価まわり
    const val=calcValuation(ctx);
    document.getElementById("rLabel").textContent = (val.r*100).toFixed(2)+"%";
    document.getElementById("gLabel").textContent = (val.gN*100).toFixed(2)+"%";
    document.getElementById("target").textContent = fmtNum(val.target.toFixed(3));
    colorValueBadge(val.target, val.price);
  }

  function fillFromRow(r, doFetch=false){
    document.getElementById("nameInput").value = r.name || "";
    document.getElementById("tickerInput").value = r.ticker || "";
    if(isFinite(r.share)) document.getElementById("shareInput").value = r.share;

    // 反映ログ
    pushLogLine(`→ 初期反映: ${r.name}（${r.ticker}） / Op_2026=${r.op["2026"]||"-"}, Op_2027=${r.op["2027"]||"-"}, share=${isFinite(r.share)?r.share+"億株":"-"}`);

    // 計算表示
    reflectCalc(r);

    // 価格自動取得
    if(doFetch && r.ticker){
      fetchPrice(r.ticker);
    }
  }

  // 初期（空でも動作）
  reflectCalc({op:{}, fcf:{}, roe:{}});
  </script>
</body>
</html>
