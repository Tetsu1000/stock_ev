<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株式評価ミニ（ROEスコア修正版）</title>
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--bg:#f8fafc;--line:#e2e8f0;}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:linear-gradient(#fff,var(--bg))}
    .wrap{max-width:1200px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .twocol{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{font-size:14px}
    input{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    input.disabled{background:#f8fafc;color:#64748b}
    .grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .grid5-head{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:6px 0 4px}
    .grid5-head div{font-size:12px;color:var(--muted);text-align:center}
    .log{white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:12px;line-height:1.5}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .box b{font-size:22px}
    .pill{padding:2px 8px;border-radius:999px;color:#fff;font-weight:600}
    .pill.great{background:#065f46}
    .pill.good {background:#34d399}
    .pill.neu  {background:#f59e0b}
    .pill.sell {background:#dc2626}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#0ea5e9;color:#fff;cursor:pointer}
    .list{display:flex;flex-direction:column;gap:8px;max-height:560px;overflow:auto}
    .rowitem{display:grid;grid-template-columns:1.6fr .9fr .7fr .8fr;gap:10px;align-items:center;border:1px solid var(--line);border-radius:10px;padding:8px 10px;cursor:pointer;background:#fff}
    .rowitem:hover{background:#f1f5f9}
    .muted{color:var(--muted);font-size:12px}
    .hdr{display:grid;grid-template-columns:1.6fr .9fr .7fr .8fr;gap:10px;margin:4px 0 8px;font-size:12px;color:var(--muted)}
    .searchrow{display:grid;grid-template-columns:1fr 180px;gap:12px}
    .tag{font-size:12px;color:#475569;background:#e2e8f0;border-radius:8px;padding:2px 6px}
  </style>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin defer></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
</head>
<body>
  <div id="app" class="wrap">読み込み中…</div>

  <script>
  (function boot(){
    if(!window.React||!window.ReactDOM||!window.XLSX){return setTimeout(boot,10);}
    const React=window.React, ReactDOM=window.ReactDOM, XLSX=window.XLSX;
    const h=React.createElement;

    /* ===== utils ===== */
    const asArr=v=>Array.isArray(v)?v:[];
    const clamp=(x,a=0,b=100)=>Math.max(a,Math.min(b,x));
    const toNum=v=>{
      if(v==null||v==="")return 0;
      if(typeof v==="number")return v;
      const s=String(v).replace(/[, \u3000]/g,"");
      const m=s.match(/^([-+]?\d+(\.\d+)?)/);
      return m?Number(m[1]):0;
    };
    const parsePercentCell=v=>{
      if(v==null||v==="")return 0;
      if(typeof v==="number"){return Math.abs(v)<=1? v*100 : v;}
      const s=String(v).trim();
      if(s.endsWith("%"))return toNum(s.replace("%",""));
      const n=toNum(s);
      return Math.abs(n)<=1? n*100 : n;
    };
    const mean=a=>a.length? a.reduce((s,v)=>s+v,0)/a.length:0;
    const stdev=a=>{const m=mean(a);const v=a.length? a.reduce((s,v)=>s+(v-m)**2,0)/a.length:0;return Math.sqrt(v);};
    const linreg=a=>{
      const y=asArr(a).map(v=>Number(v)||0);const n=y.length;
      if(n<2)return{slope:0,intercept:0,se:0};
      const x=Array.from({length:n},(_,i)=>i+1);
      const mx=mean(x),my=mean(y);
      const num=x.reduce((s,xi,i)=>s+(xi-mx)*(y[i]-my),0);
      const den=x.reduce((s,xi)=>s+(xi-mx)**2,0);
      const slope=den===0?0:num/den,intercept=my-slope*mx;
      const res=y.map((yi,i)=>yi-(slope*x[i]+intercept));
      const se=Math.sqrt(res.reduce((a,b)=>a+b*b,0)/Math.max(1,n-2));
      return{slope,intercept,se};
    };
    const median=a=>{
      const b=[...a].sort((x,y)=>x-y);const n=b.length;
      if(!n)return 0;
      return n%2?b[(n-1)/2]:(b[n/2-1]+b[n/2])/2;
    };
    const mad=a=>{
      const m=median(a);const dev=a.map(x=>Math.abs(x-m));
      return median(dev);
    };

    /* ====== App ====== */
    function App(){
      const years=[2021,2022,2023,2024,2025];
      const [dataset,setDataset]=React.useState([]);
      const [roeSlopeCohort,setRoeSlopeCohort]=React.useState(null);

      /* === コホート === */
      React.useEffect(()=>{
        if(!dataset.length)return;
        const slopes=dataset.map(r=>asArr(r.roe).filter(Number.isFinite))
          .map(a=>a.length>=2?linreg(a).slope:null)
          .filter(x=>Number.isFinite(x));
        if(!slopes.length)return;
        const mu=mean(slopes),sd=Math.max(1e-9,stdev(slopes));
        const med=median(slopes),MAD=mad(slopes);
        const madN=Math.max(1e-9,1.4826*MAD);
        setRoeSlopeCohort({mu,sd,med,madN});
      },[dataset]);

      /* === スコア算出関数 === */
      function calcBarrierScore(roeArr){
        const lastRoe = Number.isFinite(roeArr.at(-1)) ? roeArr.at(-1) : 0;
        // 12%→4、0〜8範囲内で滑らかに漸近
        const lastRoeScore = 8 / (1 + Math.exp(-25 * (lastRoe - 12) / 12));
        const slope = roeArr.length >= 2 ? linreg(roeArr).slope : 0;
        const {mu=0,sd=1e-9}=roeSlopeCohort??{};
        const z=(slope-mu)/Math.max(1e-9,sd);
        const roeGrowthScore=Math.tanh(z);
        return clamp(lastRoeScore+roeGrowthScore,0,8);
      }

      /* === ダミー表示 === */
      const sampleROE=[2,4,8,12,18,24,30,40];
      const results=sampleROE.map(v=>{
        const score=8/(1+Math.exp(-25*(v-12)/12));
        return {roe:v,score:score.toFixed(2)};
      });

      return h("div",null,
        h("h1",null,"ROEスコア確認（滑らか正規化）"),
        h("table",{border:"1",cellPadding:6},
          h("thead",null,h("tr",null,
            h("th",null,"ROE（％）"),h("th",null,"スコア")
          )),
          h("tbody",null,
            results.map((r,i)=>h("tr",{key:i},
              h("td",null,r.roe),h("td",null,r.score)
            ))
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("app")).render(h(App));
  })();
  </script>
</body>
</html>
