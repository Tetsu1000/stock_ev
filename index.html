<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>株式評価ミニ（フェーズ2・修正）</title>
  <style>
    :root{--fg:#0f172a;--muted:#64748b;--bg:#f8fafc;--line:#e2e8f0;}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:linear-gradient(#fff,var(--bg))}
    .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 16px}
    .card{background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 20px rgba(2,6,23,.06);padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{font-size:14px}
    input{width:100%;box-sizing:border-box;padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff}
    .grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    .grid5-head{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:6px 0 4px}
    .grid5-head div{font-size:12px;color:var(--muted);text-align:center}
    .log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1020;color:#e5e7eb;border-radius:10px;padding:12px;line-height:1.5}
    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .box{background:#fff;border:1px solid var(--line);border-radius:12px;padding:10px}
    .box b{font-size:22px}
    .pill{padding:2px 8px;border-radius:999px;color:#fff;font-weight:600}
    .pill.buy{background:#059669}.pill.neu{background:#f59e0b}.pill.sell{background:#dc2626}
    .btn{padding:10px 14px;border:1px solid var(--line);border-radius:10px;background:#0ea5e9;color:#fff;cursor:pointer}
  </style>
  <!-- React / ReactDOM / XLSX（deferで順序保証）-->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin defer></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin defer></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
</head>
<body>
  <div id="app" class="wrap">読み込み中…</div>

  <script defer>
  (function boot(){
    if(!window.React||!window.ReactDOM||!window.XLSX){return setTimeout(boot,10);}
    const React=window.React, ReactDOM=window.ReactDOM, XLSX=window.XLSX;

    /* ==== util ==== */
    const asArr=v=>Array.isArray(v)?v:[];
    const clamp=(x,a=0,b=100)=>Math.max(a,Math.min(b,x));
    const pretty=(n)=>Number.isFinite(n)?n.toLocaleString():"-";
    const prettyPct=(x)=>Number.isFinite(x)?(x.toFixed(2)+"%"):"-";
    const toNum=(v)=>{ if(v==null||v==="") return 0; if(typeof v==="number") return v; const s=String(v).replace(/[, \u3000]/g,""); const m=s.match(/^([-+]?\d+(\.\d+)?)/); return m? Number(m[1]):0; };
    // %セル→％値（0.089 / 8.9 / "8.9%" → 8.9）
    const parsePercentCell=(v)=>{
      if(v==null||v==="") return 0;
      if(typeof v==="number"){ return Math.abs(v)<=1? v*100 : v; }
      const s=String(v).trim();
      if(s.endsWith("%")) return toNum(s.replace("%",""));
      const n=toNum(s);
      return Math.abs(n)<=1? n*100 : n;
    };
    const linreg=(arr)=>{
      const y=asArr(arr).map(v=>Number(v)||0);
      const n=y.length; if(n<2) return {slope:0,intercept:0,se:0};
      const x=Array.from({length:n},(_,i)=>i+1);
      const mx=x.reduce((a,b)=>a+b,0)/n, my=y.reduce((a,b)=>a+b,0)/n;
      const num=x.reduce((s,xi,i)=>s+(xi-mx)*(y[i]-my),0);
      const den=x.reduce((s,xi)=>s+(xi-mx)*(xi-mx),0);
      const slope= den===0?0:num/den, intercept=my-slope*mx;
      const residuals=y.map((yi,i)=> yi-(slope*x[i]+intercept));
      const se=Math.sqrt(residuals.reduce((a,b)=>a+b*b,0)/Math.max(1,n-2));
      return {slope,intercept,se};
    };
    const mean=a=>a.length? a.reduce((s,v)=>s+v,0)/a.length:0;
    const stdev=a=>{ const m=mean(a); const v=a.length? a.reduce((s,v)=>s+(v-m)**2,0)/a.length:0; return Math.sqrt(v); };
    const median=a=>{ const b=[...a].sort((x,y)=>x-y); const n=b.length; if(!n) return 0; const m=Math.floor(n/2); return n%2? b[m] : (b[m-1]+b[m])/2; };
    const iqr=a=>{ const b=[...a].sort((x,y)=>x-y); const q=p=>{ const pos=(b.length-1)*p; const i=Math.floor(pos); const r=pos-i; return b[i]+r*(b[Math.min(i+1,b.length-1)]-b[i]); }; return Math.max(1e-9,q(0.75)-q(0.25)); };

    async function fetchQuote(tk){
      if(!tk) return {price:null,source:null};
      try{
        const r=await fetch(`https://stock-quote-api-opal.vercel.app/api/quote?ticker=${encodeURIComponent(tk)}`);
        if(r.ok){ const j=await r.json(); const px=Number(j.price ?? j.c ?? j.close); if(Number.isFinite(px)) return {price:px,source:`api(${j.source||"hosted"})`}; }
      }catch(_){}
      try{
        const r=await fetch(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=${encodeURIComponent(tk)}`,{mode:"cors"});
        if(r.ok){ const j=await r.json(); const q=j?.quoteResponse?.result?.[0]; const px=Number(q?.regularMarketPrice ?? q?.postMarketPrice ?? q?.preMarketPrice ?? q?.regularMarketPreviousClose); if(Number.isFinite(px)) return {price:px,source:"yahoo"}; }
      }catch(_){}
      try{
        let s=tk.toLowerCase(); if(s.endsWith(".t")) s=s.replace(/\.t$/,".jp");
        const r=await fetch(`https://stooq.com/q/l/?s=${encodeURIComponent(s)}&f=sd2t2ohlcv&h&e=csv`,{mode:"cors"});
        if(r.ok){ const t=await r.text(); const lines=t.trim().split(/\r?\n/); if(lines.length>=2){ const head=lines[0].split(","); const row=lines[1].split(","); const idx=head.findIndex(h=>h.toLowerCase()==="close"); const px=Number(row[idx>=0?idx:row.length-2]); if(Number.isFinite(px)) return {price:px,source:"stooq"}; } }
      }catch(_){}
      return {price:null,source:null};
    }

    function App(){
      const years=[2021,2022,2023,2024,2025];

      const [name,setName]=React.useState("");
      const [ticker,setTicker]=React.useState("7203.T");  // 初期値を戻す
      const [price,setPrice]=React.useState(0);
      const [sharesOku,setSharesOku]=React.useState(0);     // 表示・計算ともに「億株」
      const [op,setOp]=React.useState([0,0,0,0,0]);         // 億円
      const [fcf,setFcf]=React.useState([0,0,0,0,0]);       // 億円
      const [roe,setRoe]=React.useState([0,0,0,0,0]);       // ％値（表示は小数2桁）
      const [dataset,setDataset]=React.useState([]);
      const [log,setLog]=React.useState("");

      const appendLog=(s)=>setLog(p=>`${p?p+"\n":""}${s}`);

      async function refreshPrice(srcTicker=null){
        const tk=(srcTicker ?? ticker || "").trim();
        if(!tk){ appendLog("ticker が空です"); return; }
        const {price:px,source}=await fetchQuote(tk);
        if(px!=null){ setPrice(px); appendLog(`OK ${px} (${source})`); }
        else{ appendLog("価格の自動取得に失敗しました"); }
      }

      async function handleExcel(e){
        const file=e.target.files?.[0]; if(!file) return;
        const buf=await file.arrayBuffer();
        const wb=XLSX.read(buf,{type:"array"});
        const wsName=wb.SheetNames.includes("information")?"information":wb.SheetNames[0];
        const ws=wb.Sheets[wsName];
        const json=XLSX.utils.sheet_to_json(ws,{defval:null});

        const rows=asArr(json).map((r,idx)=>{
          const g=(k,...alts)=> r[k]!=null? r[k] : alts.find(a=>r[a]!=null)? r[alts.find(a=>r[a]!=null)] : null;
          const getOp=y=> toNum(g(`Op_${y}`));
          const getFcf=y=> toNum(g(`FCF_${y}`));
          const getRoe=y=> parsePercentCell(g(`ROE_${y}`));
          const shareOku= toNum(g("share","Shares_Oku","share_oku")); // D列: share（億株）
          return {
            id:idx+1,
            name: g("company","Company")||"",
            ticker: String(g("ticker","Ticker")||""),
            op: years.map(getOp),
            fcf: years.map(getFcf),
            roe: years.map(getRoe),
            sharesOku: Number(shareOku)||0
          };
        }).filter(r=>(r.name||"").trim()!=="");

        setDataset(rows);
        appendLog(`Excel loaded: ${wsName} / ${rows.length} rows`);
        if(rows.length) fillFromRow(rows[0], /*fetch*/true);
      }

      function fillFromRow(row, doFetch=false){
        setName(row.name||"");
        setTicker(row.ticker||"");
        setOp(asArr(row.op));
        setFcf(asArr(row.fcf));
        setRoe(asArr(row.roe));
        setSharesOku(Number(row.sharesOku)||0); // 億株
        if(doFetch && row.ticker) refreshPrice(row.ticker); // Excel 読込後も即時取得
      }

      // ティッカー変更時に自動取得
      React.useEffect(()=>{ if((ticker||"").trim()) refreshPrice(); },[ticker]);

      const cohort=React.useMemo(()=>{
        if(!dataset.length) return null;
        const slopeDivs=dataset.map(r=>{ const lr=linreg(r.op); const m=Math.max(1e-9,mean(r.op)); return lr.slope/m; });
        const seDivs=dataset.map(r=>{ const lr=linreg(r.op); const m=Math.max(1e-9,mean(r.op)); return lr.se/m; });
        const invs=seDivs.map(x=>1/Math.max(1e-9,x));
        const med1=median(slopeDivs), i1=iqr(slopeDivs);
        const rzArr=i1===0? slopeDivs.map(()=>0.5): slopeDivs.map(x=>(x-med1)/i1);
        const min1=Math.min(...rzArr), max1=Math.max(...rzArr);
        const min2=Math.min(...invs), max2=Math.max(...invs);
        const muSlope=mean(slopeDivs), sdSlope=Math.max(1e-9,stdev(slopeDivs));
        const muSe=mean(seDivs), sdSe=Math.max(1e-9,stdev(seDivs));
        return {med1,i1,min1,max1,min2,max2,muSlope,sdSlope,muSe,sdSe};
      },[dataset]);

      const calc=React.useMemo(()=>{
        const lr=linreg(op);
        const mOP=Math.max(1e-9,mean(op));
        const slopeDiv=lr.slope/mOP;
        const seDiv=lr.se/mOP;

        let growthScore=50, breScore=50, opTrendScore=0;
        if(cohort){
          const rz = cohort.i1===0? 0.5 : (slopeDiv-cohort.med1)/cohort.i1;
          const mm1 = (cohort.max1-cohort.min1)===0? 0.5 : (rz-cohort.min1)/(cohort.max1-cohort.min1);
          growthScore = clamp(mm1*100,0,100);

          const inv = 1/Math.max(1e-9,seDiv);
          const mm2 = (cohort.max2-cohort.min2)===0? 0.5 : (inv-cohort.min2)/(cohort.max2-cohort.min2);
          breScore = clamp(mm2*100,0,100);

          opTrendScore = ((growthScore + breScore)/2) * 0.15; // 表示は数値のみ
        }

        const fundGenScore = asArr(fcf).filter(x=>(Number(x)||0)>0).length;

        const roePct = asArr(roe).map(parsePercentCell);
        const lastRoePct = Number.isFinite(roePct[4])? roePct[4]:0;
        const roeSlopePctPerYear = linreg(roePct).slope;
        const barrierScore = (lastRoePct/3) + (roeSlopePctPerYear/10);

        const investScore = opTrendScore + fundGenScore + barrierScore;
        const investLabel = investScore<8? "売るべき企業" : investScore<10? "様子見企業" : investScore<12? "よい企業" : "すばらしい企業";

        let r=0.07, gN=0.025;
        if(cohort){
          const seStd = (seDiv - cohort.muSe)/cohort.sdSe;
          r = (seStd + 7)/100;
          const slopeStd = (slopeDiv - cohort.muSlope)/cohort.sdSlope;
          gN = (slopeStd + 2.5)/100;
        }

        // ★ 株数は「億株」のまま計算（OP なども億単位のため）
        const sharesOkuLocal = Math.max(0, Number(sharesOku)||0); // 億株

        // 目標株価（簡易：全て億単位 → 最後の割り算で円/株になる）
        let g=0; if(op[4]>0 && op[3]>0) g= op[4]/op[3]-1;
        const op5=(op[3]||0)*Math.pow(1+g,5);   // 億円
        const ni5=0.65*op5;                     // 億円
        const denom=Math.max(1e-6, r-gN);
        const tv5=ni5*(1+gN)/denom;             // 億円
        const pv=tv5/Math.pow(1+r,5);           // 億円
        const target = sharesOkuLocal>0? pv/sharesOkuLocal : 0; // （億円）/（億株）= 円/株
        const ratio = price>0? target/price : 0;
        const verdict = ratio>=2? "buy" : ratio>=1? "neu" : "sell";

        return {opTrendScore,fundGenScore,barrierScore,investScore,investLabel,r,gN,target,verdict};
      },[op,fcf,roe,sharesOku,price,cohort]);

      return (
        React.createElement(React.Fragment,null,
          React.createElement("h1",null,"株式評価ミニ（最小構成 → フェーズ2・修正版）"),
          React.createElement("div",{className:"card",style:{marginBottom:16}},
            React.createElement("div",{className:"row"},
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"会社名"),
                React.createElement("input",{value:name,onChange:e=>setName(e.target.value),placeholder:"会社名"})
              ),
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"ティッカー（例 7203.T）"),
                React.createElement("input",{value:ticker,onChange:e=>setTicker(e.target.value),placeholder:"7203.T"})
              )
            ),
            React.createElement("div",{className:"row",style:{marginTop:10}},
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"現在株価（円）"),
                React.createElement("div",{className:"row"},
                  React.createElement("input",{value:price,onChange:e=>setPrice(toNum(e.target.value)),inputMode:"decimal"}),
                  React.createElement("button",{className:"btn",onClick:()=>refreshPrice(),style:{justifySelf:"start"}}, "価格を更新")
                )
              ),
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"普通株式数（億株）※ information!D の 'share' を自動読込"),
                React.createElement("input",{value:sharesOku,onChange:e=>setSharesOku(toNum(e.target.value)),inputMode:"decimal"})
              )
            ),
            React.createElement("div",{className:"row3",style:{marginTop:10,alignItems:"end"}},
              React.createElement("div",null,
                React.createElement("div",{className:"label"},"Excel 読込（任意）"),
                React.createElement("input",{type:"file",accept:".xlsx,.xls",onChange:handleExcel})
              ),
              React.createElement("div",null, React.createElement("div",{className:"label"},"自動取得: stooq / yahoo / api")),
              React.createElement("div",null)
            )
          ),

          React.createElement("div",{className:"card",style:{marginBottom:16}},
            React.createElement("div",{className:"label"},"過去5年 営業利益（億円）"),
            React.createElement("div",{className:"grid5-head"}, [2021,2022,2023,2024,2025].map(y=>React.createElement("div",{key:y},y))),
            React.createElement("div",{className:"grid5"},
              op.map((v,i)=>React.createElement("input",{key:i,value:v,onChange:e=>setOp(op.map((x,j)=>j===i?toNum(e.target.value):x)),inputMode:"decimal"}))
            ),

            React.createElement("div",{className:"label",style:{marginTop:12}},"過去5年 FCF（億円）"),
            React.createElement("div",{className:"grid5-head"}, [2021,2022,2023,2024,2025].map(y=>React.createElement("div",{key:y},y))),
            React.createElement("div",{className:"grid5"},
              fcf.map((v,i)=>React.createElement("input",{key:i,value:v,onChange:e=>setFcf(fcf.map((x,j)=>j===i?toNum(e.target.value):x)),inputMode:"decimal"}))
            ),

            React.createElement("div",{className:"label",style:{marginTop:12}},"過去5年 ROE（%）"),
            React.createElement("div",{className:"grid5-head"}, [2021,2022,2023,2024,2025].map(y=>React.createElement("div",{key:y},y))),
            React.createElement("div",{className:"grid5"},
              roe.map((v,i)=>React.createElement("input",{
                key:i,
                value: Number.isFinite(roe[i]) ? Number(roe[i]).toFixed(2) : "",
                onChange:e=>setRoe(roe.map((x,j)=> j===i? parsePercentCell(e.target.value):x)),
                inputMode:"decimal"
              }))
            )
          ),

          React.createElement("div",{className:"row",style:{marginBottom:16}},
            React.createElement("div",{className:"card"},
              React.createElement("div",{className:"label"},"投資スコア（魅力度の合計）"),
              React.createElement("div",{className:"kpi"},
                React.createElement("div",{className:"box"},
                  React.createElement("div",{className:"muted"},"営業トレンド"),
                  React.createElement("div",null, React.createElement("b",null, Number(calc.opTrendScore).toFixed(2)))
                ),
                React.createElement("div",{className:"box"},
                  React.createElement("div",{className:"muted"},"資金創出（FCF>0年数）"),
                  React.createElement("div",null, React.createElement("b",null, Number(calc.fundGenScore).toFixed(2)))
                ),
                React.createElement("div",{className:"box"},
                  React.createElement("div",{className:"muted"},"参入障壁"),
                  React.createElement("div",null, React.createElement("b",null, Number(calc.barrierScore).toFixed(2)))
                )
              ),
              React.createElement("div",{style:{marginTop:10,fontSize:22,fontWeight:700}}, "合計：", calc.investScore.toFixed(2),
                "　", React.createElement("span",{className:"pill "+(calc.verdict==="buy"?"buy":calc.verdict==="neu"?"neu":"sell")},
                  calc.investScore<8? "売るべき企業" : calc.investScore<10? "様子見企業" : calc.investScore<12? "よい企業" : "すばらしい企業"
                )
              )
            ),
            React.createElement("div",{className:"card"},
              React.createElement("div",{className:"label"},"割安度（目標株価と比較）"),
              React.createElement("div",{className:"kpi"},
                React.createElement("div",{className:"box"}, React.createElement("div",{className:"muted"},"期待収益率 r"), React.createElement("div",null, React.createElement("b",null, prettyPct(calc.r*100)))),
                React.createElement("div",{className:"box"}, React.createElement("div",{className:"muted"},"成長率 gN（標準化）"), React.createElement("div",null, React.createElement("b",null, prettyPct(calc.gN*100)))),
                React.createElement("div",{className:"box"}, React.createElement("div",{className:"muted"},"目標株価"), React.createElement("div",null, React.createElement("b",null, pretty(calc.target))))
              )
            )
          ),

          React.createElement("div",{className:"card"},
            React.createElement("div",{className:"label"},"ログ（新しい順）"),
            React.createElement("div",{className:"log"}, log||"—")
          )
        )
      );
    }

    ReactDOM.createRoot(document.getElementById("app")).render(React.createElement(App));
  })();
  </script>
</body>
</html>
