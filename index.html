<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>診断版 / stock-ev</title>
  <style>
    body { font-family: system-ui, sans-serif; background: #f8fafc; }
    .wrap { max-width: 900px; margin: 28px auto; padding: 16px; }
    pre { background:#fff; padding:12px; border-radius:10px; box-shadow:0 1px 4px rgba(0,0,0,.05); overflow:auto }
    .ok { color:#059669 } .ng { color:#dc2626 }
  </style>

  <!-- ライブラリ（相対パス / 先頭スラッシュなし / defer） -->
  <script src="vendor/react.production.min.js" defer></script>
  <script src="vendor/react-dom.production.min.js" defer></script>
  <script src="vendor/xlsx.full.min.js" defer></script>

  <script>
    // 画面にログ出力
    const push = (html) => {
      const el = document.getElementById('log');
      el.insertAdjacentHTML('beforeend', `<div>${html}</div>`);
    };

    // すべてのエラーを画面へ
    window.onerror = (msg, src, line, col, err) => {
      push(`<div class="ng"><b>window.onerror</b><br><pre>${
        (err && (err.stack || err.message)) || msg
      }</pre></div>`);
    };
    window.onunhandledrejection = (e) => {
      const err = e.reason || e;
      push(`<div class="ng"><b>unhandledrejection</b><br><pre>${
        (err && (err.stack || err.message)) || String(err)
      }</pre></div>`);
    };

    // defer で DOM 解析完了後に実行
    document.addEventListener('DOMContentLoaded', () => {
      push('<b>診断</b>：DOM 解析完了。ライブラリ読込をチェックします…');

      // 1) ライブラリ存在チェック
      const hasReact = !!window.React;
      const hasDOM   = !!window.ReactDOM;
      const hasXLSX  = !!window.XLSX;

      push(`<div>React: ${hasReact ? '<span class="ok">OK</span>' : '<span class="ng">NG</span>'}</div>`);
      push(`<div>ReactDOM: ${hasDOM ? '<span class="ok">OK</span>' : '<span class="ng">NG</span>'}</div>`);
      push(`<div>XLSX: ${hasXLSX ? '<span class="ok">OK</span>' : '<span class="ng">NG</span>'}</div>`);

      // どれか NG ならパス/配置問題が濃厚
      if (!hasReact || !hasDOM || !hasXLSX) {
        push('<div class="ng"><b>いずれかのライブラリが読み込めていません。</b><br>index.html と vendor/ の階層、script の src を再確認してください。</div>');
        return;
      }

      // 2) 最小レンダリングテスト
      try {
        const root = document.getElementById('app');
        const e = React.createElement('div', null, '✅ React 最小レンダリング OK');
        ReactDOM.createRoot(root).render(e);
        push('<div class="ok"><b>ReactDOM.createRoot → render 成功</b></div>');
      } catch (err) {
        push(`<div class="ng"><b>React レンダリング失敗</b><br><pre>${err.stack || err.message}</pre></div>`);
      }
    });
  </script>
</head>
<body>
  <div class="wrap">
    <h1>stock-ev（診断版）</h1>
    <div id="app" style="margin:12px 0; padding:12px; background:#fff; border-radius:10px;">読み込み中…</div>
    <h3>ログ</h3>
    <div id="log"></div>
  </div>
</body>
</html>
